<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MV ENGINE — 3D EVENT STORM</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000}
canvas{display:block}
</style>
</head>
<body>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ================= CORE ================= */
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
document.body.appendChild(renderer.domElement);

const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x000000,80,2000);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,5000);
camera.position.set(0,0,120);

/* ================= LIGHT ================= */
scene.add(new THREE.AmbientLight(0xffffff,0.4));
const sun=new THREE.DirectionalLight(0xffffff,3);
sun.position.set(200,300,150);
scene.add(sun);

/* ================= HELPERS ================= */
const tmpV=new THREE.Vector3();
const viewDir=new THREE.Vector3();
const clock=new THREE.Clock();

/* ================= BALL FIELD ================= */
const ballGeo=new THREE.SphereGeometry(1,32,32);
const balls=[];
const liquids=[];
const lightnings=[];

function spawnLiquid(pos,color){
    const g=new THREE.BufferGeometry();
    const p=[],v=[],c=[];
    const n=120+Math.random()*120;
    for(let i=0;i<n;i++){
        p.push(pos.x,pos.y,pos.z);
        v.push(
            (Math.random()-0.5)*6,
            Math.random()*6,
            (Math.random()-0.5)*6
        );
        const col=new THREE.Color(color).offsetHSL(0,0,Math.random()*0.3);
        c.push(col.r,col.g,col.b);
    }
    g.setAttribute("position",new THREE.Float32BufferAttribute(p,3));
    g.setAttribute("color",new THREE.Float32BufferAttribute(c,3));
    const m=new THREE.PointsMaterial({
        size:0.7,
        vertexColors:true,
        transparent:true,
        opacity:1
    });
    const pts=new THREE.Points(g,m);
    pts.userData={vel:v,life:1};
    scene.add(pts);
    liquids.push(pts);
}

function spawnLightning(from){
    const g=new THREE.BufferGeometry();
    const p=[];
    let cur=from.clone();
    for(let i=0;i<12;i++){
        p.push(cur.x,cur.y,cur.z);
        cur=cur.clone().add(
            new THREE.Vector3(
                (Math.random()-0.5)*20,
                -Math.random()*40,
                (Math.random()-0.5)*20
            )
        );
        p.push(cur.x,cur.y,cur.z);
    }
    g.setAttribute("position",new THREE.Float32BufferAttribute(p,3));
    const m=new THREE.LineBasicMaterial({
        color:0x88ccff,
        transparent:true,
        opacity:1
    });
    const l=new THREE.LineSegments(g,m);
    l.userData={life:0.2};
    scene.add(l);
    lightnings.push(l);
}

/* ================= CREATE BALLS ================= */
for(let i=0;i<900;i++){
    const mat=new THREE.MeshStandardMaterial({
        color:new THREE.Color().setHSL(Math.random(),0.6,0.65),
        emissive:new THREE.Color().setHSL(Math.random(),1,0.3),
        emissiveIntensity:0.4,
        roughness:0.35,
        metalness:0.3
    });

    const b=new THREE.Mesh(ballGeo,mat);

    const r=300+Math.random()*1000;
    const a=Math.random()*Math.PI*2;
    const b2=Math.random()*Math.PI;

    b.position.set(
        Math.cos(a)*Math.sin(b2)*r,
        Math.cos(b2)*r,
        Math.sin(a)*Math.sin(b2)*r
    );

    b.userData={
        base:b.position.clone(),
        scale:0.6+Math.random()*2.5,
        phase:Math.random()*Math.PI*2,
        speed:0.3+Math.random()*2,
        event:0,
        timer:Math.random()*5
    };

    b.scale.setScalar(b.userData.scale);
    scene.add(b);
    balls.push(b);
}

/* ================= INPUT ================= */
let yaw=0,pitch=0,drag=false,px=0,py=0;
addEventListener("pointerdown",e=>{drag=true;px=e.clientX;py=e.clientY});
addEventListener("pointerup",()=>drag=false);
addEventListener("pointermove",e=>{
    if(!drag)return;
    yaw-=(e.clientX-px)*0.002;
    pitch-=(e.clientY-py)*0.002;
    pitch=Math.max(-1.4,Math.min(1.4,pitch));
    px=e.clientX;py=e.clientY;
});

/* ================= LOOP ================= */
function loop(){
    requestAnimationFrame(loop);
    const d=clock.getDelta();
    const t=clock.elapsedTime;

    camera.rotation.set(pitch,yaw,0);
    camera.getWorldDirection(viewDir);

    /* BALL EVENTS */
    for(const b of balls){
        const u=b.userData;
        u.timer-=d;

        if(u.timer<0){
            u.event=Math.floor(Math.random()*6);
            u.timer=2+Math.random()*5;

            if(u.event===3) spawnLiquid(b.position,b.material.color);
            if(u.event===4) spawnLightning(b.position);
        }

        let depth=0;
        if(u.event===0) depth=Math.sin(t*u.speed+u.phase)*40;           // 呼吸
        if(u.event===1) depth=Math.sin(t*4+u.phase)*120;               // 急接近
        if(u.event===2) depth=-Math.abs(Math.sin(t*2))*160;            // 離脱
        if(u.event===3) depth=Math.sin(t*6)*60;                         // 割れ
        if(u.event===4) depth=Math.sin(t*8)*80;                         // 雷反応
        if(u.event===5) depth=Math.sin(t*1.5)*200;                     // ドリフト

        tmpV.copy(u.base)
            .addScaledVector(viewDir,depth);

        b.position.lerp(tmpV,0.08);

        const pulse=1+Math.sin(t*3+u.phase)*0.4;
        b.scale.setScalar(u.scale*pulse);

        b.rotation.x+=0.01+Math.random()*0.02;
        b.rotation.y+=0.01+Math.random()*0.02;
    }

    /* LIQUID */
    for(let i=liquids.length-1;i>=0;i--){
        const l=liquids[i];
        l.userData.life-=d;
        const pos=l.geometry.attributes.position.array;
        const vel=l.userData.vel;
        for(let j=0;j<vel.length/3;j++){
            pos[j*3]+=vel[j*3];
            pos[j*3+1]+=vel[j*3+1];
            pos[j*3+2]+=vel[j*3+2];
            vel[j*3+1]-=0.15;
        }
        l.geometry.attributes.position.needsUpdate=true;
        l.material.opacity=l.userData.life;
        if(l.userData.life<=0){
            scene.remove(l);
            liquids.splice(i,1);
        }
    }

    /* LIGHTNING */
    for(let i=lightnings.length-1;i>=0;i--){
        const l=lightnings[i];
        l.userData.life-=d;
        l.material.opacity=l.userData.life*5;
        if(l.userData.life<=0){
            scene.remove(l);
            lightnings.splice(i,1);
        }
    }

    camera.fov=60+Math.sin(t*1.2)*8;
    camera.updateProjectionMatrix();

    renderer.render(scene,camera);
}
loop();

/* ================= RESIZE ================= */
addEventListener("resize",()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
